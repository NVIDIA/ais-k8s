# AIStore Keycloak Integration

> This is currently in an alpha testing state. Breaking changes should be expected. 

This directory contains instructions and reference installation for setting up an instance of [Keycloak](https://www.keycloak.org/) to authenticate with AIStore. 

## How AIS Authenticates

AIStore uses JWT tokens to "authenticate" users.
In practice, this is a mix of authentication and authorization, as the JWT also contains all the information AIS needs to determine if a request can succeed. 
Rather than authenticating a request with a role and using that role to lookup authorized actions, AIS simply checks the signature of the JWT along with the claims. 
This minimizes the latency impact of the token verification as AIS does not have to query any service to validate user access. 

## Generating Tokens

AIS JWT tokens for authentication and authorization can be provided by **any** service.
AIS must be configured to trust tokens generated by that service and the tokens must contain the required AIS claims. 

AIS uses a few extra custom claims to validate access. 
These are subject to change as we improve AIS auth capabilities. 

- `username` -- to be replaced with OIDC standard claim `sub`
- `expires` -- to be replaced with OIDC standard claim `exp`
- `admin` -- Total admin access, supersedes all other claims 
- `buckets` -- List of buckets to access
- `clusters` -- List of AIS clusters to access 

Example token claim format: 
```
{
  "username": "john",
  "expires": "2025-10-05T12:00:00Z",
  "clusters": [
    {
      "id": "abc123-cluster-uuid",
      "alias": "prod-cluster",
      "perm": "123456",
      "urls": ["http://proxy1.example.com:8080"]
    },
    {
      "id": "",
      "perm": "789"
    }
  ],
  "buckets": [
    {
      "bck": {
        "name": "my-bucket",
        "provider": "ais",
        "namespace": {
          "uuid": "abc123-cluster-uuid",
          "name": ""
        }
      },
      "perm": "999"
    }
  ]
}
```

Here we provide what's needed to get started with Keycloak for AIS authentication. 
See the [Keycloak quickstarts repo](https://github.com/keycloak/keycloak-quickstarts) for some other installation options.

Follow the [installation guide](./INSTALLATION.md) for instructions to get a sample deployment running on an existing cluster.

To create an non-production automated deployment on a local KinD cluster, see [test-cluster.sh](./test-cluster.sh).

## AIStore Realm

> As shipped, this is ONLY for development usage. If using this realm for **ANY** production purpose, you **MUST** update the password for the `ais-admin` user. 

The AIStore Realm is auto-imported in both the Docker and KinD deployment automation.

This realm comes by default with a client `AIStore` and an admin user `ais-admin` with password `admin-pass`.
This user contains the `admin` claim and any tokens fetched by this user will have full admin access to any AIS cluster that trusts this issuer. 
