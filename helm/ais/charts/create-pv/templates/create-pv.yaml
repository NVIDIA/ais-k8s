# Set variables based on the root context to be accessible within the range
{{- $cluster := .Values.cluster -}}
{{- $mpathInfo := .Values.mpathInfo -}}
{{- $storageClass := $mpathInfo.storageClass -}}
{{- $mpathSize := $mpathInfo.size -}}
{{- $mounts := $mpathInfo.mounts -}}
{{- $nodes := .Values.nodes -}}

# Create hostPath PersistentVolumes for all provided mounts on all provided nodes
{{- range $nodeIndex, $node := $nodes }}
  {{- range $mountIndex, $mount := $mounts }}
apiVersion: v1
kind: PersistentVolume
metadata:
  name: {{ $node }}-pv-{{ $mount.path | replace "/" "-" | trimPrefix "-" }}
  labels:
    type: local
    cluster: {{ $cluster }}
    mpath: pv-{{ $mount.path | replace "/" "-" | trimPrefix "-" }}
spec:
  storageClassName: {{ $storageClass }}
  capacity:
    storage: {{ $mpathSize }}
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: {{ $mount.path }}
  claimRef:
    name: {{ $cluster }}-{{ $mount.path | replace "/" "-" | trimPrefix "-" }}-{{ $cluster }}-target-{{ $nodeIndex }}
    namespace: {{ $.Values.namespace }}
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - {{ $node }}
---
  {{- end }}
{{- end }}
