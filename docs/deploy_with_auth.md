# Deploying in K8s with non-native Auth Servers

While we do provide our own [authN service](./authn.md), many users may prefer to use an existing or more feature-rich authentication and authorization solution.
AIStore itself does not have any special requirement that the AIStore AuthN service is used, but only requires additional claims on any provisioned JWT.
This allows for full compatibility with existing authentication services.
In this doc we'll demonstrate how to deploy a local K8s cluster with Keycloak, AIS operator, and AIStore.

## How AIS Authenticates

AIStore uses JWT tokens to "authenticate" users.
In practice, this is a mix of authentication and authorization, as the JWT also contains all the information AIS needs to determine if a request can succeed. 
Rather than authenticating a request with a role and using that role to lookup authorized actions, AIS simply checks the signature of the JWT along with the claims. 
This minimizes the latency impact of the token verification as AIS does not have to query any service to validate user access. 

## Generating Tokens

AIS JWT tokens for authentication and authorization can be provided by **any** service.
AIS must be configured to trust tokens generated by that service and the tokens must contain the required AIS claims. 

AIS uses a few extra custom claims to validate access. 
These are subject to change as we improve AIS auth capabilities. 

- `admin` -- Total admin access, supersedes all other claims 
- `buckets` -- List of buckets to access
- `clusters` -- List of AIS clusters to access 

Example token claim format: 
```json
{
  "username": "john",
  "expires": "2025-10-05T12:00:00Z",
  "clusters": [
    {
      "id": "abc123-cluster-uuid",
      "alias": "prod-cluster",
      "perm": "123456",
      "urls": ["http://proxy1.example.com:8080"]
    },
    {
      "id": "",
      "perm": "789"
    }
  ],
  "buckets": [
    {
      "bck": {
        "name": "my-bucket",
        "provider": "ais",
        "namespace": {
          "uuid": "abc123-cluster-uuid",
          "name": ""
        }
      },
      "perm": "999"
    }
  ]
}
```

## Deploy Keycloak

[Keycloak](https://www.keycloak.org/) is a full-featured, open source, CNCF incubating project with a wide range of installation options and environments. 
We provide a basic set of instructions and automation for setting up the prerequisites and installing a simple keycloak deployment. 
This also includes a development AIS realm with a basic cluster admin user.

Follow the instructions [linked here](../auth/keycloak/README.md) to get started with Keycloak. 

## Create Namespaces for AIS

Our charts do this automatically, but this is needed before creating additional resources below:

```bash
kubectl create ns ais
kubectl create ns ais-operator-system
kubectl label namespace ais ais-trust=true
kubectl label namespace ais-operator-system ais-trust=true
```

## Create an Admin Secret

The AIS operator must be able to request an admin token for controlling the AIS cluster.
Apply this manifest to create this secret with provided AIS admin credentials for the development realm.
Here we do it with `envsubst` to template the values

```bash
export SU_NAME="ais-admin"
export SU_PASS="12345"
envsubst < ../auth/keycloak/manifests/admin-secret.template.yaml | kubectl apply -f -
```

## Trust Manager 

The above deployment installs `trust-manager` but we still need to make a trust bundle for the issuer's self-signed certificate. 

Apply the trust-bundle manifest to create ConfigMaps with a CA certificate the operator and AIS can use to verify.  

`kubectl apply -f ../auth/keycloak/manifests/trust-bundle.yaml`

## Deploy Operator

Deploy the operator with the keycloak environment values to use the K8s ConfigMaps and Secret created above: 

`helmfile sync -f ../helm/operator/helmfile.yaml -e keycloak`

## Deploy AIS

Deploy the AIS cluster with the keycloak environment values.
These define both the issuers the AIS cluster allows as well as the login info the AIS operator should use to provision a token for admin access to this cluster. 

`helmfile sync -f ../helm/ais/helmfile.yaml -e keycloak`